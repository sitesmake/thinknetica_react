<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello react</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.13/c3.css" />
</head>
<body>
<div id="app"></div>

<script src="https://fb.me/react-15.1.0.js"></script>
<script src="https://fb.me/react-dom-15.1.0.js"></script>
<script src="https://cdn.jsdelivr.net/lodash/4/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/momentjs/2.14.1/moment-with-locales.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.13/c3.js"></script>

<script type="text/babel">
const { DOM, PropTypes } = React;

const { bind } = _;

const LoremPixelImage = ({src, width, height, alt}) => (
  <Image
    src={src}
    width={(Number(src.split('/')[3]) || width)}
    height={(Number(src.split('/')[4]) || height)}
    alt={alt}
  />
)

LoremPixelImage.defaultProps = {
  src: 'http://lorempixel.com/50/50',
  width: 50,
  height: 50,
  alt: 'Lorem Ipsum'
}

LoremPixelImage.propTypes = {
  src: PropTypes.string,
  width: PropTypes.number,
  height: PropTypes.number,
  alt: PropTypes.string
}

const Image = ({src, width, height, alt}) => (
  DOM.img({
    src: src,
    width: width,
    height: height,
    alt: alt
  })
)

Image.propTypes = {
  src: PropTypes.string,
  width: PropTypes.number,
  height: PropTypes.number,
  alt: PropTypes.string
}

const TextBox = (props) => (
  DOM.span(null, props.children)
);

const Like = (props) => (
  <span>
    Likes: {props.likes}
    <button onClick={() => props.incrementLikes(props.id)}>Like</button>
  </span>
)

const BlogItem = ({ image, meta, id, incrementLikes, text }) => (
  <div>
    <LoremPixelImage src={image.src} />
    <TextBox>
      {text},
      by: {meta.author},
      created at: {meta.createdAt},
      updated at: {meta.updatedAt},
      <Like likes={meta.likes} incrementLikes={incrementLikes} id={id}/>
    </TextBox>
  </div>
)

BlogItem.defaultProps = {
  image: {
    src: 'http://lorempixel.com/50/50',
    width: 50,
    height: 50,
    alt: 'React - super!'
  },
  text: 'Untitled Blog',
  id: Date.now(),
  meta: {
    author: 'Me',
    createdAt: moment(0).format('lll'),
    updatedAt: moment().format('lll'),
    likes: 0
  }
}

BlogItem.propTypes = {
  image: PropTypes.shape(LoremPixelImage.propTypes),
  text: PropTypes.string,
  id: PropTypes.number,
  meta: PropTypes.shape({
    author: PropTypes.string,
    createdAt: PropTypes.string,
    updatedAt: PropTypes.string,
    likes: PropTypes.number
  })
}

const BlogList = ({items, incrementLikes}) => (
  DOM.ul(
    null,
    _.map(
      items,
      (item) => (
        <li key={item.id}>
          <BlogItem {...item} incrementLikes={ incrementLikes }/>
        </li>
      )
    )
  )
)

class BlogPage extends React.Component {
  constructor(props) {
    super(props);
    this.state = { posts: this.props.posts };
    this.incrementLikes = this.incrementLikes.bind(this);
  }

  incrementLikes(id) {
    // let copy = Object.assign({}, this.state.posts);
    let copy = _.cloneDeep(this.state.posts);

    const index = copy.findIndex(item => item.id == id)

    copy[index]["meta"]["likes"]++;

    this.setState({
      posts: copy
    })
  }

  render() {
    return(
      <div>
        <BlogList items={ this.state.posts } incrementLikes={ this.incrementLikes } />
        <Chart
          columns = {
            _.map(
              this.props.posts,
              (item) => (
                ([item.text, item.meta.likes])
              )
            )
          }
        />
      </div>
    )
  }
}

const blogItems = [
  {
    image: {
      src: 'http://lorempixel.com/200/200'
    },
    text: 'Blog 1',
    id: 1,
    meta: {
      author: 'Philosopher',
      createdAt: moment().subtract(2000, 'years').format('lll'),
      updatedAt: moment().format('lll'),
      likes: 10
    }
  },
  {
    image: {
      src: 'http://lorempixel.com/200/100'
    },
    text: 'Blog 2',
    id: 2,
    meta: {
      author: 'Knight',
      createdAt: moment().subtract(500, 'years').format('lll'),
      updatedAt: moment().format('lll'),
      likes: 50
    }
  },
  {
    image: {
      src: 'http://lorempixel.com/200/50'
    },
    text: 'Blog 3',
    id: 3,
    meta: {
      author: 'Physicist',
      createdAt: moment().subtract(200, 'years').format('lll'),
      updatedAt: moment().format('lll'),
      likes: 20
    }
  }

];

class Chart extends React.Component {
  componentDidMount() {
      this.chart = c3.generate({
        bindto: ReactDOM.findDOMNode(this.refs.chart),
        data: {
          columns:  this.props.columns,
          type: 'pie'
        }
      })
  }

  componentWillUnmount() {
    this.chart.destroy();
  }

  componentWillReceiveProps(nextProps) {
    if (nextProps != this.props) {
      this.chart.load({
        columns: nextProps.columns
      })
    }
  }

  render() {
    return (
      <div ref="chart" />
    )
  }
}

ReactDOM.render(
  <BlogPage posts={ blogItems } />,
  document.getElementById('app')
);
</script>

</body>
</html>
