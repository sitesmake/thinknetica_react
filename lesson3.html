<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello react</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.13/c3.css" />
</head>
<body>
<div id="app"></div>

<script src="https://fb.me/react-15.1.0.js"></script>
<script src="https://fb.me/react-dom-15.1.0.js"></script>
<script src="https://cdn.jsdelivr.net/lodash/4/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/momentjs/2.14.1/moment-with-locales.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.13/c3.js"></script>

<script type="text/babel">
const { DOM, PropTypes } = React;

const { bind } = _;

class LoremPixelImage extends React.Component {
  constructor(props) {
    super(props);
  }

  render() {
    return(
      <Image
        src={this.props.src}
        width={(Number(this.props.src.split('/')[3]) || this.props.width)}
        height={(Number(this.props.src.split('/')[4]) || this.props.height)}
        alt={this.props.alt}
      />
    )
  }
}

LoremPixelImage.defaultProps = {
  src: 'http://lorempixel.com/50/50',
  width: 50,
  height: 50,
  alt: 'Lorem Ipsum'
}

LoremPixelImage.propTypes = {
  src: PropTypes.string,
  width: PropTypes.number,
  height: PropTypes.number,
  alt: PropTypes.string
}

class Image extends React.Component {
  constructor(props) {
    super(props);
  }

  render() {
    return(
      DOM.img({
        src: this.props.src,
        width: this.props.width,
        height: this.props.height,
        alt: this.props.alt
      }, null)
    )
  }
}

Image.propTypes = {
  src: PropTypes.string,
  width: PropTypes.number,
  height: PropTypes.number,
  alt: PropTypes.string
}

const TextBox = (props) => (
  DOM.span(null, props.children)
);

const Like = (props) => (
  <span>
    Likes: {props.likes}
    <button onClick={() => props.incrementLikes(props.id)}>Like</button>
  </span>
)

class BlogItem extends React.Component {
  render() {
    return (
      <div>
        <LoremPixelImage src={this.props.image.src} />
        <TextBox>
          {this.props.text},
          by: {this.props.meta.author},
          created at: {this.props.meta.createdAt},
          updated at: {this.props.meta.updatedAt},
          <Like likes={this.props.meta.likes} incrementLikes={this.props.incrementLikes} id={this.props.id}/>
        </TextBox>
      </div>
    )
  }
}

BlogItem.defaultProps = {
  image: {
    src: 'http://lorempixel.com/50/50',
    width: 50,
    height: 50,
    alt: 'React - super!'
  },
  text: 'Untitled Blog',
  id: Date.now(),
  meta: {
    author: 'Me',
    createdAt: moment(0).format('lll'),
    updatedAt: moment().format('lll'),
    likes: 0
  }
}

BlogItem.propTypes = {
  image: PropTypes.shape(LoremPixelImage.propTypes),
  text: PropTypes.string,
  id: PropTypes.number,
  meta: PropTypes.shape({
    author: PropTypes.string,
    createdAt: PropTypes.string,
    updatedAt: PropTypes.string,
    likes: PropTypes.number
  })
}

class BlogList extends React.Component {
  render() {
    return DOM.ul(
      null,
      _.map(
        this.props.items,
        (item) => (
          <li key={item.id}>
            <BlogItem {...item} incrementLikes={ this.props.incrementLikes }/>
          </li>
        )
      )
    )
  }
}

class BlogPage extends React.Component {
  constructor(props) {
    super(props);
    this.state = { posts: this.props.posts };
    this.incrementLikes = this.incrementLikes.bind(this);
  }

  incrementLikes(id) {
    let copy = Object.assign({}, this.state.posts);
    copy[id-1]["meta"]["likes"]++;
    this.setState({
      posts: copy
    })
  }

  render() {
    return(
      <div>
        <BlogList items={ this.state.posts } incrementLikes={ this.incrementLikes } />
        <Chart
          columns = {
            _.map(
              this.props.posts,
              (item) => (
                ([item.text, item.meta.likes])
              )
            )
          }
        />
      </div>
    )
  }
}

const blogItems = [
  {
    image: {
      src: 'http://lorempixel.com/200/200'
    },
    text: 'Blog 1',
    id: 1,
    meta: {
      author: 'Philosopher',
      createdAt: moment().subtract(2000, 'years').format('lll'),
      updatedAt: moment().format('lll'),
      likes: 10
    }
  },
  {
    image: {
      src: 'http://lorempixel.com/200/100'
    },
    text: 'Blog 2',
    id: 2,
    meta: {
      author: 'Knight',
      createdAt: moment().subtract(500, 'years').format('lll'),
      updatedAt: moment().format('lll'),
      likes: 50
    }
  },
  {
    image: {
      src: 'http://lorempixel.com/200/50'
    },
    text: 'Blog 3',
    id: 3,
    meta: {
      author: 'Physicist',
      createdAt: moment().subtract(200, 'years').format('lll'),
      updatedAt: moment().format('lll'),
      likes: 20
    }
  }

];

class Chart extends React.Component {
  componentDidMount() {
      this.chart = c3.generate({
        bindto: ReactDOM.findDOMNode(this.refs.chart),
        data: {
          columns:  this.props.columns,
          type: 'pie'
        }
      })
  }

  componentWillUnmount() {
    this.chart.destroy();
  }

  componentWillReceiveProps(nextProps) {
    if (nextProps != this.props) {
      this.chart.load({
        columns: nextProps.columns
      })
    }
  }

  render() {
    return (
      <div ref="chart" />
    )
  }
}

ReactDOM.render(
  <BlogPage posts={ blogItems } />,
  document.getElementById('app')
);
</script>

</body>
</html>
